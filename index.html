<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leitor PDF Inteligente</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Leitor PDF Inteligente</h1>
  <div id="tooltip"></div>
  <input type="file" id="fileInput" accept="application/pdf" />
  <div id="content"></div>
  <div id="translation"></div>

  <div id="dailyWordsPanel">
  <h3>Palavras de <span id="currentDateLabel"></span></h3>
  <table id="dailyWordsList" style="width: 100%;">
  <thead>
    <tr>
      <th>Palavra</th>
      <th>TraduÃ§Ã£o</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
  </table>
  </div>

  <script src="pdf.min.js"></script>
  <script>
    let currentPage = 1;
    const pageLimit = 10;
    let totalPages = 0;
    let loadedPdf = null;
    const fileInput = document.getElementById("fileInput");
    const contentDiv = document.getElementById("content");
    const translationDiv = document.getElementById("translation");
    const checkBtn = document.getElementById("checkPronunciationBtn");
    const resultDiv = document.getElementById("result");
    let currentWord = "";

    // ConfiguraÃ§Ã£o do PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.min.js';

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file.type !== "application/pdf") return;

      const fileReader = new FileReader();
      fileReader.onload = function () {
        const typedarray = new Uint8Array(this.result);
            pdfjsLib.getDocument(typedarray).promise.then(async (pdf) => {
              contentDiv.innerHTML = "";

              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const items = content.items;

                let lines = {};

                items.forEach(item => {
                  const y = Math.round(item.transform[5]);

                  let matchedLine = null;
                  for (let key in lines) {
                    if (Math.abs(key - y) <= 2) {
                      matchedLine = key;
                      break;
                    }
                  }
                  

                  const entry = { str: item.str, x: item.transform[4], fontSize: item.transform[0] };
                  if (matchedLine === null) {
                    lines[y] = [entry];
                  } else {
                    lines[matchedLine].push(entry);
                  }
                });

                const sortedY = Object.keys(lines).sort((a, b) => b - a);
                const linesText = sortedY.map(y => {
                  const sortedLine = lines[y].sort((a, b) => a.x - b.x);
                  
                  return sortedLine.map(w => {
                    return w.fontSize >= 16 ? `<strong>${w.str}</strong>` : w.str;
                  }).join(" ");
                });

                // ðŸ”¹ TÃ­tulo da pÃ¡gina
                const pageHeader = document.createElement("h2");
                pageHeader.textContent = `ðŸ“„ PÃ¡gina ${i}`;
                pageHeader.style.marginTop = "40px";
                pageHeader.style.color = "#444";
                contentDiv.appendChild(pageHeader);

                // ðŸ”¹ Renderizar texto da pÃ¡gina
                linesText.forEach(para => {
                  const p = document.createElement("p");
                  const words = para.trim().split(/\s+/);
                  words.forEach(word => {
                    const span = document.createElement("span");
                    span.innerHTML = word + " ";
                    span.onclick = () => handleClick(span, word);
                    p.appendChild(span);
                  });
                  contentDiv.appendChild(p);
                });
              }
            });

      };
      fileReader.readAsArrayBuffer(file);
    });

    function renderText(text) {
      contentDiv.innerHTML = "";
      const paragraphs = text.split("\n");

      paragraphs.forEach(para => {
        const p = document.createElement("p");
        const words = para.trim().split(/\s+/);

        words.forEach(word => {
          const span = document.createElement("span");
          span.innerHTML = word + " ";
          span.onclick = () => handleClick(span, word);
          p.appendChild(span);
        });

        contentDiv.appendChild(p);
      });
    }


    async function handleClick(el, word) {
      document.querySelectorAll("#content span").forEach(s => s.classList.remove("highlight"));
      el.classList.add("highlight");

        speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = 'en-US';
        utterance.rate = 1; // vocÃª pode ajustar a velocidade aqui (1 = normal)
        speechSynthesis.speak(utterance);

      const rect = el.getBoundingClientRect();
      const tooltip = document.getElementById("tooltip");

      let translated = "";
      try {
        const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=pt&dt=t&q=${encodeURIComponent(word)}`);
        const data = await res.json();
        translated = data[0][0][0];
      } catch (err) {
        translated = "Erro ao traduzir.";
      }

      tooltip.innerHTML = `
        <div><strong>${word}</strong> significa: ${translated}</div>
        <button id="addWordBtn">âž• Salvar esta palavra</button><br><br>
        <button id="checkPronunciationBtn">Testar minha pronÃºncia ðŸŽ¤</button>
        <div id="result" style="margin-top: 8px; font-weight: bold;"></div>
      `;

      tooltip.style.left = `${rect.left + window.scrollX}px`;
      tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
      tooltip.style.display = "block";

      currentWord = word.toLowerCase();

      setTimeout(() => {
        const checkBtn = document.getElementById("checkPronunciationBtn");
        const resultDiv = document.getElementById("result");

        // BotÃ£o de adicionar palavra Ã  tabela
        document.getElementById("addWordBtn").onclick = () => {
          const today = new Date();
          const dayKey = today.toISOString().split("T")[0];
          let wordList = JSON.parse(localStorage.getItem("words-" + dayKey) || "[]");

          if (wordList.length >= 10) {
            alert("VocÃª jÃ¡ salvou 10 palavras hoje!");
            return;
          }

          const alreadyExists = wordList.some(item => item.word === currentWord);
          if (!alreadyExists) {
            wordList.push({ word: currentWord, translation: translated });
            localStorage.setItem("words-" + dayKey, JSON.stringify(wordList));
            updateDailyWordsPanel();
          }
        };

        // BotÃ£o de testar pronÃºncia
        checkBtn.onclick = () => {
          if (!('webkitSpeechRecognition' in window)) {
            alert("Seu navegador nÃ£o suporta reconhecimento de voz. Use o Google Chrome.");
            return;
          }

          const recognition = new webkitSpeechRecognition();
          recognition.lang = "en-US";
          recognition.interimResults = false;
          recognition.maxAlternatives = 1;

          recognition.onstart = () => {
            checkBtn.innerText = "ðŸŽ™ï¸ Ouvindo... fale agora";
            resultDiv.innerText = "";
          };

          recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.toLowerCase().trim();
            const confidence = event.results[0][0].confidence;

            if (transcript === currentWord) {
              resultDiv.innerText = "âœ… PronÃºncia correta!";
              resultDiv.style.color = "green";
            } else {
              resultDiv.innerText = `âŒ VocÃª disse: "${transcript}". Tente novamente.`;
              resultDiv.style.color = "red";
            }

            checkBtn.innerText = "Testar minha pronÃºncia ðŸŽ¤";

            setTimeout(() => {
              document.getElementById("tooltip").style.display = "none";
            }, 2000);
          };

          recognition.onerror = (e) => {
            console.error("Erro no reconhecimento:", e);
            resultDiv.innerText = "Erro ao reconhecer sua voz.";
            resultDiv.style.color = "orange";
            checkBtn.innerText = "Testar minha pronÃºncia ðŸŽ¤";
          };

          recognition.onend = () => {
            if (resultDiv.innerText === "") {
              resultDiv.innerText = "âš ï¸ Nada foi detectado. Tente novamente.";
              resultDiv.style.color = "gray";
              checkBtn.innerText = "Testar minha pronÃºncia ðŸŽ¤";
            }
          };

          recognition.start();
        };
      }, 50);

    }

    checkBtn.addEventListener("click", () => {
  if (!('webkitSpeechRecognition' in window)) {
    alert("Reconhecimento de voz nÃ£o suportado neste navegador. Use o Google Chrome.");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    checkBtn.innerText = "Ouvindo... Fale agora";
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript.toLowerCase().trim();
    if (transcript === currentWord) {
      resultDiv.innerText = "âœ… PronÃºncia correta!";
      resultDiv.style.color = "green";
    } else {
      resultDiv.innerText = `âŒ VocÃª disse: "${transcript}". Tente novamente.`;
      resultDiv.style.color = "red";
    }
    checkBtn.innerText = "Testar minha pronÃºncia ðŸŽ¤";
  };

  recognition.onerror = () => {
    resultDiv.innerText = "Erro ao reconhecer sua voz.";
    resultDiv.style.color = "orange";
    checkBtn.innerText = "Testar minha pronÃºncia ðŸŽ¤";
  };

  recognition.start();
});

document.addEventListener("click", (e) => {
  const tooltip = document.getElementById("tooltip");
  if (!e.target.matches("#content span")) {
    tooltip.style.display = "none";
  }
});

function updateDailyWordsPanel() {
  const today = new Date();
  const dayKey = today.toISOString().split("T")[0];
  const displayDate = today.toLocaleDateString("pt-BR");

  document.getElementById("currentDateLabel").innerText = displayDate;

  const tbody = document.querySelector("#dailyWordsList tbody");
  tbody.innerHTML = "";

  const wordList = JSON.parse(localStorage.getItem("words-" + dayKey) || "[]");

  wordList.forEach(({ word, translation }, index) => {
    const row = document.createElement("tr");

    // Palavra clicÃ¡vel para pronÃºncia
    const wordCell = document.createElement("td");
    wordCell.textContent = word;
    wordCell.style.color = "blue";
    wordCell.style.cursor = "pointer";
    wordCell.style.textDecoration = "underline";
    wordCell.onclick = () => {
      const utterance = new SpeechSynthesisUtterance(word);
      utterance.lang = 'en-US';
      speechSynthesis.cancel();
      speechSynthesis.speak(utterance);
    };

    // TraduÃ§Ã£o
    const translationCell = document.createElement("td");
    translationCell.textContent = translation;

    // BotÃ£o de remoÃ§Ã£o
    const removeCell = document.createElement("td");
    const removeBtn = document.createElement("button");
    removeBtn.textContent = "âŒ";
    removeBtn.style.cursor = "pointer";
    removeBtn.onclick = () => {
      wordList.splice(index, 1);
      localStorage.setItem("words-" + dayKey, JSON.stringify(wordList));
      updateDailyWordsPanel();
    };
    removeCell.appendChild(removeBtn);

    // Monta a linha
    row.appendChild(wordCell);
    row.appendChild(translationCell);
    row.appendChild(removeCell);
    tbody.appendChild(row);
  });
}

updateDailyWordsPanel();

</script>
</body>
</html>
